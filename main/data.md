# 高级数据管理

除了最基本的线路里程、标尺、车次时刻数据外，本系统还支持更加丰富的数据。这部分在最初接触软件时或许不大常用，但如果需要用到，可以参考本篇文档。

## 列车数据

### 运行线管理

自本系统`2.0.0`版本开始，“车次”和“运行线”之间不再是一一对应的关系，而是**一趟列车可以有任意多的运行线**。这是从`1.x`到`2.x`版本的关键变化，也是本系统与ETRC系统的重要区别之一。一条**运行线**是指同一列车在本线上运行的一段连续、单向的区间，在图上用一条线表示。如图所示，

![item](img/item.png)

图中`40001`次成都-成都西区间，红牌楼-石羊线路所区间分别是两段运行线；图中`40103/4`次成都-红牌楼，红牌楼-成都西分别是两段运行线（因为运行方向变了）。这种情况下，40103次在成都-红牌楼间是下行，红牌楼-成都西间是上行，也即**上下行不是列车的性质，而是运行线的性质**。

当选中车次时，该车次的所有运行线都会被同时选中。例如上图中的40001次。

?> 虽然如此，但在绝大多数情况下所需要处理的运行线情况是比较简单的。这样的分段以及折返的情况是比较少见的。并且，对于大多数的情况，自动运行线管理已经能够处理的比较好，因此不必深究本节。但若要处理的情况比较刁钻，或者遇到问题，可以参考本部分。

运行线管理有两种方式，即**自动管理**和**手动管理**。一般情况下，我们建议使用自动管理，而仅仅用手动管理处理极其特殊的情况。

#### 自动管理

本节介绍运行线自动管理的逻辑。有关设置项是运行图设置中的**最大跨越站数**，参见[运行图显示控制](main/overview.md#运行图显示控制)。

对于没有设置过运行线规则的车次，系统**在铺画运行线时**，按照以下规则处理。

- 如果相邻的两个**可铺画站点**间跳过的车站数超过了“最大跨越站数”的设置项，则在这个区间断开运行线。

  > “可铺画站点”是指同时在<u>车次时刻表</u>和<u>本线站点表</u>中出现的站。最大跨越站数的统计，包含车次时刻表中不在本线的站和本线站表中<u>应该在而不在</u>车次时刻表中的站两部分。
  >
  > 例如，如果本线站表和车次时刻表中的站序如下表所示：
  >
  > | 线路站表 | 车次时刻表      | 匹配情况 |
  > | -------- | --------------- | -------- |
  > | 达州     | 达州 00:00      | 匹配     |
  > | 覃家坝   |                 | 不匹配   |
  > |          | 渡市 00:10/12   | 不匹配   |
  > | 三汇镇   | 三汇镇 00:23/25 | 匹配     |
  > | 土溪     | 土溪 00:40/...  |          |
  >
  > 则对于车次而言，达州、三汇镇是两个相邻的可铺画站点。两站点间的跨越站数为2。如果系统设置的“最大跨越站数”为1或者0，则达州和三汇镇间的运行线会断开。
  >
  > 对于当前方向而言，本应不通过的站不计入跨越站数。例如，对于上行的运行线而言，下行单向通过的站理应不在时刻表上，故不计入跨越站数。

- 如果区间运行方向改变，则断开运行线，且从折返站开始重新铺画运行线。上一段运行线不带结束标签，下一段运行线不带开始标签。因此从运行图上来看，运行线是连着的，但实际上是属于两段运行线。

- 如果按照前两段规则计算的某一段运行线中有效站数小于2，则取消这段运行线。

?> 这样的管理模式适用于时刻表较完整的情况，如果输入的时刻表是不完整的，例如只输入了停车站的时刻，其他站没有输入（但其实是经过了本线的，只是默认通过而没有填时刻），则按照自动运行线管理规则，运行线可能被断开。此种情况下，可将“最大跨越站数”设为一充分大的数字。

!> 引入运行线管理机制后，列车在本线运行的里程（及依据里程计算的均速）、列车入图出图方向等数据的计算都依赖于运行线信息。如果没有铺画过运行图，也没有手动给出运行线信息，则这些数据无法计算。

#### 手动管理

为了应对特殊情况，我们同样提供了运行线手动管理方式。手动管理方式见`当前车次设置`停靠面板（`ctrl+I`），在“运行线管理”栏，可以选择是否要自动管理。点击`设置`弹出对话框如下图所示。

![manual](img/manualItem.png)

左侧显示的是本次列车的站点；右侧表中是运行线信息，一行是一条运行线，可以设置运行线方向，是否设置起始结束标签。

在左侧选择一组车站，点击“添加”后，将选择的第一个站至最后一站之间都作为一条运行线的数据。请注意运行线管理不可以重复，且必须按顺序添加。如果添加错误，只能删除再重新添加。

!> 此设置项仅在手动管理模式下生效。如果在自动管理下编辑，则重新铺画运行图时，手动管理的数据无效，且会被系统自动管理的内容覆盖。

?> 在手动管理模式下，系统铺画运行图后，仍会对运行线信息做一些调整，例如剔除掉不能在本线铺画的区段。但用户指定的分界点不受影响。

?> 一般来说，我们建议用自动管理，除非个别情况下自动管理失效，再用手动管理来调整。

### 列车类型系统

相比ETRC，pyETRC系统的一大特色是所有数据都要有依据，不会随意为用户指定参数，或者即使给了默认参数，也可以由用户调整。列车类型系统是这条原则的一个例子。列车的类型系统和是否为客车，都可以由用户规定。

?> 本系统已经预制了较为完整的国铁类型系统。正常情况下，无需用户修改。但如果用户需要添加自己的类型规则，或者不使用国铁类型系统（例如，用本系统来进行城市轨道交通运行图分析），则可以修改或重新设计类型系统，此时可以参阅本节内容。

#### 概述

列车类型系统主要包括两个方面，

- 列车种类。是指对于每一个车次，它属于哪一类车次，例如`快速` `特快`。列车种类有两种获取方式：
  - 针对每个车次手动设定。此项可在`当前车次设置`面板中设定。
  - 根据车次形式，使用**正则表达式**推定。详见后文。
- 是否为客车的属性。除列车种类外，所有车次还可分为`客车` 和`非客车`两大类。类似的，也有两种方式获取：
  - 针对每个车次手动设定。此项可在`当前车次设置`面板中设定。
  - 根据列车种类自动推导。可以规定每一种<u>列车种类</u>是否属于客车。详见后文。

#### 列车种类判定及其应用

本系统列车种类判定的**唯一**依据是`类型管理`功能设定的类型表。设置项见`运行图设置`停靠面板（快捷键`ctrl+G`），点击`类型管理`后的`设置`，弹出对话框如下图所示。

![type](img/type.png)

表中每一行是一个**种类判据**（名称可以重复），第二列是**全车次**应当符合的正则表达式。关于**正则表达式**（regular expression）的语法，请自行查阅有关资料。

表中各行的顺序表示优先级关系。当要对一趟车的全车次（例如：`5648/5`）做类型判断时，**从上到下依次**用正则表达式匹配，如果符合，则判定车次属于第一列所示的类型，并结束判定过程。

第三列规定该种类型是否属于旅客列车类型。

?> 在`当前车次设置`停靠面板中，如果`列车种类`一栏留空，则点击“确定”时，由本节所述规则判定种类。

列车种类数据的应用主要体现在：

- 按列车种类筛选车次。详见[通用车次筛选器](main/review.md#通用车次筛选器)。
- 选择要显示运行线的车次。详见[显示车次筛选](main/review#显示车次筛选)。
- 在[车站时刻表](main/review#车站时刻表)、[车次列表](main/overview#车次列表)等处显示，供用户参考。

#### 客货车判定及其应用

对某一车次是否为客车的判定主要依据的是类型系统中各个种类是否为客车的设置项，参见[列车种类判定及其应用](#列车种类判定及其应用)。

?> 在`当前车次设置`停靠面板中，如果`列车种类`后的`旅客列车`选择框为半选中（Partial Checked）状态，则依据列车种类，自动判定是否为客车。且这个判定是动态的，即如果改变了该种类是否为客车的选项，每个该种类下的车次都受影响。但若将此选项强制勾选或者不勾选，则不再受列车种类调整的影响。

客货车判定目前主要应用于：

- 自动决定运行线宽度。即决定默认情况下使用`默认客车线宽`还是`默认货车线宽`。此设置项参见[运行图显示控制](main/overview#运行图显示控制)。
- 自动决定车站营业性质。详见[是否营业及其应用](#是否营业及其应用)。



## 天窗

本系统中的天窗数据仅作提示用，作为线路数据的一部分，可以在图上画出，但暂不包含更多的逻辑上的功能。本系统支持每条线路可以有两套标尺数据，即综合维修天窗和综合施工天窗。两套数据互相独立。

可从`窗口->天窗编辑`菜单，或者用快捷键`ctrl+1`（数字`1`）打开或隐藏天窗编辑停靠面板。编辑界面如下图所示。

![forbidEdit](img/forbidEdit.png)

其中`上下行分设`选项的意义同[标尺数据](main/overview#标尺数据)中的相同选项。勾选或取消`显示天窗`，可控制显示/隐藏下行和上行天窗。天窗在运行图中的展示效果如下图所示。

![forbid](img/forbid.png)

其中，下行天窗用左上->右下的阴影线标注，上行天窗为右上->左下，上下行交叉区段，或者上下行不分设的区段，则为交叉阴影线。上图中标注天窗的三个小时区间，自左向右分别为下行、上下行交叉、上行。

综合维修天窗用灰色阴影线，并无背景色；综合施工天窗在蓝色阴影线的基础上，添加浅灰色背景。上图中，成都~红牌楼区段为综合维修天窗，红牌楼~石羊线路所区段为综合施工天窗的样例。

#### 编辑技巧

考虑到输入时间比较麻烦以及天窗数据的一般规律性，我们在天窗编辑面板中设计了一些快速操作方法。这些快捷操作可以通过右键菜单调出，也可以用相应快捷键调用。具体如下：

- 复制本行数据到下一行（`Alt+C`）。将当前行数据复制到下一行，同时光标移动到下一行。
- 复制数据到本方向所有行（`Alt+Shift+C`）。重复上一项操作，直至本方向（上行或者下行）最后一行。也就是说，对于垂直天窗的情况，直接编辑第一行，然后用此功能复制就可以了。
- 计算结束时间（`Alt+E`）。按照表格上方设定的**默认时长**，根据本行设定的开始时间，加上默认时长，填写结束时间。适用于天窗时长基本固定但并非垂直天窗的情形，此时只需要编辑各个区间的开始时间，再用本功能计算结束时间。
- 计算开始时间（`Alt+R`）。和<u>计算结束时间</u>类似，只是本功能通过结束时间，反推开始时间。
- 计算所有结束时间（`Alt+Shift+E`）。对每一行应用<u>计算结束时间</u>。
- 计算所有开始时间（`Alt+Shift+R`）。对每一行应用<u>计算开始时间</u>。

## 车底交路

### 概述

本系统允许每趟车属于**至多一个**车底交路。之所以强调车底交路，是为了和机车交路相对应，也就是仅能有至多一个交路，而不能分段设置（即换挂）。

一个交路是一组车次的序列。序列中的车次可以是属于本运行图的车次，也即本运行图中有该车次的时刻信息，称为**实体车次**；也可以是不属于本运行图的车次，也即**虚拟车次**。

### 交路编辑界面

使用菜单`窗口->交路编辑`或者快捷键`ctrl+4`可以打开或者隐藏交路编辑停靠面板。在交路编辑面板中双击一行，或者点击`编辑`或`添加`，弹出针对单个交路进行编辑的对话框。交路编辑停靠面板及对话框的界面如图所示。

![circuitEdit](img/circuitEdit.png)

其中，`交路名称`必须是唯一的非空字符串；而`车底型号` `担当局段` `备注或说明`则可以是任何内容，仅作提示用。

`识别车次`的作用是重新判定实体车次与虚拟车次。这将遍历所有车次，对于符合实体条件的车次（即本运行图中可以找到该车次的时刻信息）则设置为实体车次；否则设置为虚拟车次。实体车次和虚拟车次的来源参见[添加车次](#添加车次)和[交路字符串解析](#交路字符串解析)。`批量识别`将对所有交路应用以上操作。

`解析文本`和`批量解析`详见[交路字符串解析](#交路字符串解析)。

`连线`选项指出是否希望在该车次的运行线**开始处**绘制与上一车次之间的连接线。具体逻辑参见[运行线连接](#运行线连接)。

### 添加车次

在交路设置的对话框中点击`前插`或者`后插`则弹出添加车次的对话框。添加车次分为添加实体车次和虚拟车次两种情况。添加实体车次的界面如下图所示，

![addRealTrain](img/addRealTrain.png)

首先在`车次`栏输入，按`Tab`键后，右侧的下拉菜单中弹出符合条件的车次，默认选中第一个，并自动填写始发站、终到站等信息。点击`确定`即可完成插入。

!> 只有下拉菜单中选中的车次才是有效的。如果找不到车次，或者选择的车次已经属于一个交路，则弹出告警信息。此时不能插入车次。

?> 极个别情况会出现数据不同步的情况。也就是车次并不属于某个交路，但因为某些操作，导致无法添加到交路，提示“该车次已经属于xxx交路”。这种情况下，可以到`当前车次编辑`（`ctrl+I`）面板中，点击`车底交路`后的`清除`来强制删除。

虚拟车次的插入比较简单，只需要输入有关信息即可，不再附图。请注意插入时并不会检查车次是否唯一，也不会检查车次是否属于当前运行图。

### 运行线连接

### 股道占用分析

### 交路字符串解析

### 交路图



## 列车停站数据

### 是否营业及其应用

### 车站股道